////
This content is automatically generated from a template, see
https://github.com/hacbs-contract/ec-policies/tree/main/docsrc
Do not edit it manually.
////

:numbered:

= Release Policy

These rules are applied to pipeline run attestations associated with
container images built by HACBS.

== Commit Signature Rules

[#disallowed_commit_signature_email]
=== link:#disallowed_commit_signature_email[Signatures is a valid email address]

Enterprise Contract verifies if a valid email address was used to sign a commit 

* Rule type: [rule-type-indicator warn]#WARNING#
* Warning message: `Signature %s in commit %s is not a valid email address`
* Short name: `disallowed_commit_signature_email`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/commit/commit_signature.rego#L12[Source, window="_blank"]

[#disallowed_commit_signature_domain]
=== link:#disallowed_commit_signature_domain[Signatures in a commit that are disallowed]

Enterprise Contract has a list of allowed domains that a commit can be signed
off with.

The allowed email domains are:

----
redhat.com
----

* Rule type: [rule-type-indicator warn]#WARNING#
* Warning message: `Signature %s in commit %s has disallowed domain`
* Short name: `disallowed_commit_signature_domain`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/commit/commit_signature.rego#L30[Source, window="_blank"]

== Attestation Task Bundle Rules

[#disallowed_task_reference]
=== link:#disallowed_task_reference[Task bundle was not used or is not defined]

Check for existence of a task bundle. Enforcing this rule will
fail the contract if the task is not called from a bundle.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Task '%s' does not contain a bundle reference`
* Short name: `disallowed_task_reference`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_task_bundle.rego#L16[Source, window="_blank"]

[#empty_task_bundle_reference]
=== link:#empty_task_bundle_reference[Task bundle reference is empty]

Check for a valid task bundle reference being used.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Task '%s' uses an empty bundle image reference`
* Short name: `empty_task_bundle_reference`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_task_bundle.rego#L31[Source, window="_blank"]

[#out_of_date_task_bundle]
=== link:#out_of_date_task_bundle[Task bundle is out of date]

Check if the Tekton Bundle used for the Tasks in the attestation
is the most recent acceptable one. See the list of acceptable
task bundles at xref:acceptable_bundles.adoc#_task_bundles[Acceptable Bundles] or look at
link:https://github.com/hacbs-contract/ec-policies/blob/main/data/acceptable_tekton_bundles.yml[data/acceptable_tekton_bundles.yml]
in this git repository.

* Rule type: [rule-type-indicator warn]#WARNING#
* Warning message: `Task '%s' uses an out of date task bundle '%s'`
* Short name: `out_of_date_task_bundle`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_task_bundle.rego#L50[Source, window="_blank"]

[#unacceptable_task_bundle]
=== link:#unacceptable_task_bundle[Task bundle is not acceptable]

Check if the Tekton Bundle used for the Tasks in the attestation
are acceptable given the tracked effective_on date. See the list of acceptable
task bundles at xref:acceptable_bundles.adoc#_task_bundles[Acceptable Bundles] or look at
link:https://github.com/hacbs-contract/ec-policies/blob/main/data/acceptable_tekton_bundles.yml[data/acceptable_tekton_bundles.yml]
in this git repository.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Task '%s' uses an unacceptable task bundle '%s'`
* Short name: `unacceptable_task_bundle`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_task_bundle.rego#L75[Source, window="_blank"]

== Attestation Type Rules

[#unknown_att_type]
=== link:#unknown_att_type[Unknown attestation type found]

A sanity check that the attestation found for the image has the expected
attestation type. Currently there is only one attestation type supported,
`https://in-toto.io/Statement/v0.1`.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Unknown attestation type '%s'`
* Short name: `unknown_att_type`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/attestation_type.rego#L18[Source, window="_blank"]

== Not Useful Rules

[#bad_day]
=== link:#bad_day[A dummy rule that always fails]

It's expected this rule will be skipped by policy configuration.
This rule is for demonstration and test purposes and should be deleted soon.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `It just feels like a bad day to do a release`
* Short name: `bad_day`
* Effective from: `Sat, 01 Jan 2022 00:00:00 +0000`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/not_useful.rego#L15[Source, window="_blank"]

== Step Image Registries Rules

[#disallowed_task_step_image]
=== link:#disallowed_task_step_image[Task steps ran on container images that are disallowed]

Enterprise Contract has a list of allowed registry prefixes. Each step in each
each TaskRun must run on a container image with a url that matches one of the
prefixes in the list.

The allowed registry prefixes are:

----
quay.io/redhat-appstudio/
registry.access.redhat.com/
registry.redhat.io/
----

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Step %d in task '%s' has disallowed image ref '%s'`
* Short name: `disallowed_task_step_image`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/step_image_registries.rego#L20[Source, window="_blank"]

== Tasks Rules

[#tasks_missing]
=== link:#tasks_missing[No tasks run]

This policy enforces that at least one Task is present in the PipelineRun
attestation.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `No tasks found in PipelineRun attestation`
* Short name: `tasks_missing`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/tasks.rego#L34[Source, window="_blank"]

[#tasks_required]
=== link:#tasks_required[Required tasks not run]

This policy enforces that the required set of tasks is run in a
PipelineRun.

The required task refs are:

----
add-sbom-and-push
clamav-scan
deprecated-image-check
get-clair-scan
sanity-inspect-image
sanity-label-check
sanity-optional-label-check
sast-go
----

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Required task(s) '%s' not found in the PipelineRun attestation`
* Short name: `tasks_required`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/tasks.rego#L50[Source, window="_blank"]

== Test Rules

[#test_result_skipped]
=== link:#test_result_skipped[Some tests were skipped]

Collects all tests that have their result set to "SKIPPED".

* Rule type: [rule-type-indicator warn]#WARNING#
* Warning message: `The following tests were skipped: %s`
* Short name: `test_result_skipped`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L103[Source, window="_blank"]

[#test_data_missing]
=== link:#test_data_missing[No test data found]

None of the tasks in the pipeline included a HACBS_TEST_OUTPUT
task result, which is where Enterprise Contract expects to find
test result data.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `No test data found`
* Short name: `test_data_missing`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L16[Source, window="_blank"]

[#test_results_missing]
=== link:#test_results_missing[Test data is missing the results key]

Each test result is expected to have a 'results' key. In at least
one of the HACBS_TEST_OUTPUT task results this key was not present.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Found tests without results`
* Short name: `test_results_missing`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L30[Source, window="_blank"]

[#test_result_unsupported]
=== link:#test_result_unsupported[Unsupported result in test data]

This policy expects a set of known/supported results in the test data
It is a failure if we encounter a result that is not supported.

The supported results are:

----
SUCCESS
FAILURE
ERROR
SKIPPED
----

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `Test '%s' has unsupported result '%s'`
* Short name: `test_result_unsupported`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L51[Source, window="_blank"]

[#test_result_failures]
=== link:#test_result_failures[Test result is FAILURE or ERROR]

Enterprise Contract requires that all the tests in the test results
have a successful result. A successful result is one that isn't a
"FAILURE" or "ERROR". This will fail if any of the tests failed and
the failure message will list the names of the failing tests.

* Rule type: [rule-type-indicator deny]#FAILURE#
* Failure message: `The following tests did not complete successfully: %s`
* Short name: `test_result_failures`
* https://github.com/hacbs-contract/ec-policies/blob/main/policy/release/test.rego#L74[Source, window="_blank"]

